---
export interface Props {
    linkTo?: string
}
const { linkTo = "http://127.0.0.1:8000/app/posts/viewers/" } = Astro.props;
---
<style>
    @keyframes slideUp {
        from {
            transform: translateY(100%);
        }
        to {
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    .slide-up {
        animation: slideUp 0.5s ease-in-out;
    }
</style>

<body class="bg-gray-100 min-h-screen">
    <main id="dynamic-header" class="container mx-auto mt-6 p-4" hx-get={linkTo} hx-trigger="load" hx-target="#data-response">

        <script>
            // Add Authorization header to all requests
            document.body.addEventListener('htmx:configRequest', (event) => {
                const token = localStorage.getItem('accessToken');
                if (token) {
                    event.detail.headers['Authorization'] = "Bearer " + token;
                }
            });
        </script>
        <div id="postContainer">
            <!-- Posts will be dynamically added here -->
        </div>
    </main>

        <!-- Modal for Image Preview -->
        <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center hidden z-50">
            <div class="relative w-[90%] max-w-4xl">
                <img id="modalImage" class="w-full max-h-[90vh] border-8 border-white rounded-lg shadow-xl transition-transform duration-300 transform scale-95" />
                <button id="closeImageModal" class="absolute top-4 right-4 text-white text-4xl font-bold hover:text-gray-400 focus:outline-none">&times;</button>
            </div>
        </div>



    <!-- Modal for comments -->
    <div id="commentModal" style="z-index:999;" class="fixed bottom-0 inset-x-0 bg-white rounded-t-lg shadow-lg max-w-xl mx-auto max-h-screen overflow-y-auto hidden slide-up">
        <div class="p-4">
            <h2 class="text-xl font-bold mb-4">Comments</h2>
            <div id="commentList" class="mb-4">
                <!-- Comments will be dynamically added here -->
            </div>
            <form id="commentForm" class="mt-4">
                <textarea id="newComment" class="w-full p-2 border rounded" rows="3" placeholder="Write a comment..."></textarea>
                <div class="flex justify-between items-center mt-2">
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-300">Post Comment</button>
                    <button id="closeCommentModal" type="button" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 transition duration-300">Close</button>
                </div>
            </form>
            <div id="data-response" hidden></div>
        </div>
    </div>
    <script>
        document.getElementById("dynamic-header").addEventListener("htmx:afterRequest", function (event) {
            const postsContainer = document.getElementById("postContainer");
            const data = event.detail.xhr.response;
            const posts = JSON.parse(data);

            postsContainer.innerHTML = ""; // Clear existing posts

            posts.forEach((post) => {
                const postElement = document.createElement("div");
                postElement.className = "post bg-white rounded-lg shadow-md p-4 mb-6 fade-in max-w-lg mx-auto";
                postElement.innerHTML = `
                    <div class="flex items-center mb-4">
                        <img class="w-10 h-10 rounded-full" src="${post.avatar ? post.avatar : 'https://i.pravatar.cc/40?img=6'}" alt="${post.author.first_name} avatar">
                        <div class="ml-4">
                            <h2 class="font-semibold">${post.author.first_name} ${post.author.last_name}</h2>
                            <span class="text-gray-500 text-sm">${new Date(post.created_at).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' })}</span>
                        </div>
                    </div>
                    <p class="text-gray-700 mb-4">${post.content}</p>
                    ${post.image ? `<img src="${post.image}" alt="Post image" class="w-full h-64 object-cover rounded-lg mb-4 post-image cursor-pointer">` : ""}
                    <div class="flex items-center space-x-2">
                        <button class="text-blue-600 hover:bg-blue-100 px-3 py-1 rounded-full transition duration-300 flex items-center" hx-post="http://127.0.0.1:8000/app/posts/react/">
                            Likes
                            <span class="ml-2 text-gray-600" id="like-count">${post.likes_count}</span>
                        </button>
                        <button class="comment-btn text-blue-600 hover:bg-blue-100 px-3 py-1 rounded-full transition duration-300" data-post-id="${post.id}">Comment</button>
                    </div>
                `;
                
                postsContainer.appendChild(postElement);
            });
                });
        // فتح الصورة مع التمرير
        document.addEventListener("click", (event) => {
            if (event.target.classList.contains("post-image")) {
                const imageUrl = event.target.src;
                openImageModal(imageUrl);

                // إبقاء مكان المستخدم
                document.documentElement.style.scrollBehavior = "smooth"; // يجعل التمرير سلسًا
            }
        });

        function openImageModal(imageUrl) {
            const imageModal = document.getElementById("imageModal");
            const modalImage = document.getElementById("modalImage");
            modalImage.src = imageUrl;
            imageModal.classList.remove("hidden");
        }

        // إغلاق الـ modal
        document.getElementById("closeImageModal").addEventListener("click", () => {
            document.getElementById("imageModal").classList.add("hidden");
        });

        // إغلاق الـ modal عند النقر على الخلفية
        document.getElementById("imageModal").addEventListener("click", (e) => {
            if (e.target === document.getElementById("imageModal")) {
                document.getElementById("imageModal").classList.add("hidden");
            }
        });
   
    </script>
</body>
