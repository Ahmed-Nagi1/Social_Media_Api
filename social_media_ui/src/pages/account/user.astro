---
const link = "http://127.0.0.1:8000/auth/user/";
const changeEmail = "http://127.0.0.1:8000/auth/change-email/";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Profile</title>
  </head>

  <body class="bg-gray-100 flex items-center justify-center h-screen">
    <div class="bg-white shadow-lg rounded-lg p-8 max-w-sm w-full space-y-8">
      <div
        id="username-content"
        class="border-b"
        hx-get={link}
        hx-target="#email-data"
        hx-trigger="load delay:0.000001s"
      >
        <h2 class="text-xl font-bold text-gray-800 mb-4">Change Email</h2>
        <form class="space-y-4">
          <input name="action" id="action" hidden />
          <!-- Email Field -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700"
              >Email</label
            >
            <input
              type="text"
              id="email"
              name="email"
              placeholder="Enter your email"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            />
          </div>

          <!-- Resend Verification Button -->
          <button
            id="resendButton"
            type="button"
            class="px-4 py-2 bg-gray-600 text-white text-sm font-medium rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
            hx-vals='{"action": "resend"}'
            hx-trigger="click"
            hx-post={changeEmail}
            hx-target="#responseDataUsername"
          >
            Resend Verification
          </button>

          <script>
            const button = document.getElementById("resendButton");
            const disableDuration = 5 * 60 * 1000; // 5 دقائق بالمللي ثانية
            const localStorageKey = "resendButtonDisabledUntil";

            function disableButton() {
              const endTime = Date.now() + disableDuration;
              localStorage.setItem(localStorageKey, endTime);

              updateButtonState(endTime);
            }

            function updateButtonState(endTime) {
              const now = Date.now();
              const remainingTime = endTime - now;

              if (remainingTime > 0) {
                button.disabled = true;
                button.classList.remove("hover:bg-gray-700");
                button.classList.add("bg-gray-400", "cursor-not-allowed");

                // تحديث النص بمؤقت
                const countdown = Math.ceil(remainingTime / 1000);
                button.textContent = `Wait ${countdown} seconds`;

                // تحديث العد التنازلي كل ثانية
                setTimeout(() => updateButtonState(endTime), 1000);
              } else {
                button.disabled = false;
                button.classList.remove("bg-gray-400", "cursor-not-allowed");
                button.classList.add("hover:bg-gray-700");
                button.textContent = "Resend Verification";
                localStorage.removeItem(localStorageKey);
              }
            }

            // استعادة حالة الزر بعد إعادة التحميل
            const savedEndTime = localStorage.getItem(localStorageKey);
            if (savedEndTime && Date.now() < savedEndTime) {
              updateButtonState(parseInt(savedEndTime, 10));
            }

            // إرفاق الحدث لتعطيل الزر عند النقر
            button.addEventListener("click", () => {
              disableButton();
            });
          </script>

          <!-- Submit Button -->
          <div>
            <button
              type="submit"
              class="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              hx-vals='{"action": "change"}'
              hx-trigger="click"
              hx-post={changeEmail}
              hx-target="#responseDataUsername"
            >
              Save Email
            </button>
          </div>

          <div id="responseDataUsername"></div>
        </form>
      </div>

      <div
        id="name-content"
        hx-get={link}
        hx-target="#name-data"
        hx-trigger="load delay:0.000001s"
      >
        <h2 class="text-xl font-bold text-gray-800 mb-3">Update Name</h2>
        <form
          class="space-y-4"
          hx-patch={link}
          hx-target="#responseDataName"
          onsubmit="document.getElementById('').classList.remove('hidden'); return false;"
        >
          <!-- First Name Field -->
          <div>
            <label
              for="first-name"
              class="block text-sm font-medium text-gray-700">First Name</label
            >
            <input
              type="text"
              id="first_name"
              name="first_name"
              placeholder="Enter your first name"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            />
          </div>
          <!-- Last Name Field -->
          <div>
            <label
              for="last-name"
              class="block text-sm font-medium text-gray-700">Last Name</label
            >
            <input
              type="text"
              id="last_name"
              name="last_name"
              placeholder="Enter your last name"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            />
          </div>

          <!-- Submit Button -->
          <div>
            <button
              type="submit"
              class="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            >
              Save Name
            </button>
          </div>
          <div id="responseDataName"></div>
          <div class="flex justify-between mt-4">
            <a href="/account/change-password" class="text-sm text-blue-600 hover:underline">Change Password</a>
          </div>
        </form>
      </div>
    </div>
    <!-- Loading Screen -->
    <div
      id="loadingScreen"
      class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden"
    >
      <div class="flex flex-col items-center">
        <div class="flex justify-center items-center">
          <div
            class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"
          >
          </div>
        </div>
        <p class="mt-4 text-white text-lg text-center">Processing...</p>
      </div>
    </div>

    <div id="email-data" hidden></div>
    <div id="name-data" hidden></div>

    <script>
      const token = localStorage.getItem("accessToken");

      document.addEventListener("DOMContentLoaded", () => {
        ["username-content", "name-content"].forEach((id) => {
          const form = document.getElementById(id);
          if (form) {
            const headers = {
              Authorization: `Bearer ${token}`,
            };
            form.setAttribute("hx-headers", JSON.stringify(headers));
          }
        });
      });

      document.addEventListener("htmx:afterOnLoad", function (event) {
        try {
          const responseData = event.detail.xhr.responseText;
          const data = JSON.parse(responseData);

          if (event.target.id === "username-content") {
            document.getElementById("email").value = data.email || "";
          } else if (event.target.id === "name-content") {
            document.getElementById("first_name").value = data.first_name || "";
            document.getElementById("last_name").value = data.last_name || "";
          }
        } catch (error) {
          console.error("Error updating form fields: ", error);
        }
      });
    </script>

    <script>
      const handleResponse = (targetId, message) => {
        document.getElementById("loadingScreen").classList.add("hidden");
        const responseBox = document.getElementById(targetId);
        const response = message.xhr.response;
        const statusCode = message.xhr.status;
        const responseValues = Object.values(response)
          .join("")
          .replace(/[{}[\]"']/g, " ");

        if (statusCode === 200 || statusCode === 201) {
          responseBox.className = "bg-green-100 text-green-800 p-4 rounded";
          responseBox.textContent = `(${statusCode}): ${responseValues}.`;
        } else {
          responseBox.className = "bg-red-100 text-red-800 p-4 rounded";
          responseBox.textContent = `(${statusCode}): ${responseValues}`;
        }
      };

      document.addEventListener("htmx:afterRequest", function (event) {
        if (event.detail.target.id === "responseDataUsername") {
          handleResponse("responseDataUsername", event.detail);
        } else if (event.detail.target.id === "responseDataName") {
          handleResponse("responseDataName", event.detail);
        }
      });
    </script>
  </body>
</html>
